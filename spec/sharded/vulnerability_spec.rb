require 'spec_helper'

RSpec.describe Stinger::Sharded::Vulnerability do
  let(:sharded_asset) do
    FactoryBot.create(:asset,
                      :ip_address_locator,
                      :client_id => SHARDED_CLIENT_ID)
  end
  let!(:apple_cve) { FactoryBot.create(:cve, :apple) }
  let!(:oracle_cve) { FactoryBot.create(:cve, :oracle) }

  before do
    # ActiveRecord::Base.logger = Logger.new(STDOUT)
    FactoryBot.create(:client, :sharded)

    Octopus.using(:client_3) do
      FactoryBot.create(:vulnerability,
                        :client_id => SHARDED_CLIENT_ID,
                        :asset => sharded_asset,
                        :cve_id => apple_cve.id)

      FactoryBot.create(:vulnerability,
                        :client_id => SHARDED_CLIENT_ID,
                        :asset => sharded_asset,
                        :cve_id => oracle_cve.id)
    end
  end

  subject(:vuln) do
    Stinger::Sharded::Vulnerability.using(:client_3).first
  end

  it 'has two vulnerabilities in the DB' do
    vuln_count =
      Stinger::Sharded::Vulnerability
      .using(:client_3)
      .count

    expect(vuln_count).to eq(2)
  end

  it 'belongs to asset' do
    expect(vuln.asset.id).to eq(sharded_asset.id)
  end

  it 'belongs to a cve' do
    expect(vuln.cve).to eq(apple_cve)
  end
end
